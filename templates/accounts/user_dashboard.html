{% extends 'base.html' %}
{% block content %}
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} mt-2">{{ message }}</div>
  {% endfor %}
{% endif %}
<h2>User Dashboard</h2>
<p>Welcome, {{ request.user.get_full_name|default:request.user.username }}.</p>
<div class="row">
  {% if default_address %}
    <div class="alert alert-info mb-3">
      <strong>Your default pickup address:</strong><br>
      {{ default_address.address_text }}<br>
      {% if default_address.region %}Region: {{ default_address.region }}<br>{% endif %}
      {% if default_address.landmark %}Landmark: {{ default_address.landmark }}<br>{% endif %}
    </div>
  {% else %}
    <div class="alert alert-warning mb-3">
      <strong>No pickup address set.</strong> Please <a href="/accounts/profile/">add an address in your profile</a> before requesting a pickup.
    </div>
  {% endif %}
  <div class="col-md-8">
    <div class="card mb-3">
      <div class="card-header">Upcoming Trash Collections</div>
      <div class="card-body">
          {% if upcoming %}
            <ul class="list-group">
              {% for p in upcoming %}
                <li class="list-group-item d-flex justify-content-between align-items-start">
                  <div>
                    <strong>{{ p.get_state_display }}:</strong> {{ p.address }}
                    <div class="small text-muted">{{ p.scheduled_time }}</div>
                  </div>
                  <div>
                    {% if p.collector %}
                      <span class="badge bg-primary">Collector: {{ p.collector.get_full_name|default:p.collector.username }}</span>
                    {% else %}
                      <span class="badge bg-secondary">Unassigned</span>
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>No upcoming pickups.</p>
          {% endif %}
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">Request a Pickup</div>
      <div class="card-body">
        {% if default_address %}
        <form method="post" action="/pickups/request/">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label">Trash type</label>
            <select name="trash_type" class="form-select">
              <option value="household">Household</option>
              <option value="recyclable">Recyclable</option>
              <option value="bulk">Bulk</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Preferred date</label>
            <input type="date" name="preferred_date" class="form-control" />
          </div>
          <div class="mb-2">
            <label class="form-label">Notes</label>
            <textarea name="notes" class="form-control" rows="2"></textarea>
          </div>
          <button class="btn btn-success" type="submit">Request pickup</button>
        </form>
        {% else %}
        <div class="alert alert-warning">
          You must <a href="/accounts/profile/">add an address in your profile</a> before requesting a pickup.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card mb-3">
      <div class="card-header">Notifications</div>
      <div class="card-body">
        {% if notifications %}
          <ul class="list-unstyled">
            {% for n in notifications %}
              <li class="mb-2">
                <div>{{ n.message }}</div>
                <div class="small text-muted">{{ n.created_at }}</div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No notifications.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
