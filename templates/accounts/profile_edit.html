{% extends 'base.html' %}
{% block content %}
<h2 class="mb-4"><i class="bi bi-pencil-square text-primary me-2"></i>Edit Profile</h2>

<form method="post" action="" id="profileEditForm">
  {% csrf_token %}
  
  <div class="row">
    <div class="col-md-6">
      <div class="mb-3">
        <label class="form-label fw-semibold">Phone</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-telephone"></i></span>
          <input type="text" name="phone" class="form-control" value="{{ profile.phone }}" />
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="mb-3">
        <label class="form-label fw-semibold">Backup contact</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-person-rolodex"></i></span>
          <input type="text" name="backup_contact" class="form-control" value="{{ profile.backup_contact }}" />
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="mb-3">
        <label class="form-label fw-semibold">Notification method</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-bell"></i></span>
          <select name="notification_method" class="form-select">
            <option value="sms" {% if profile.notification_method == 'sms' %}selected{% endif %}>SMS</option>
            <option value="email" {% if profile.notification_method == 'email' %}selected{% endif %}>Email</option>
            <option value="inapp" {% if profile.notification_method == 'inapp' %}selected{% endif %}>In-app</option>
          </select>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="mb-3">
        <label class="form-label fw-semibold">Preferred days</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-calendar-week"></i></span>
          <input type="text" name="preferred_days" class="form-control" value="{{ profile.preferred_days }}" placeholder="Mon,Tue,Fri" />
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="mb-3">
        <label class="form-label fw-semibold">Preferred time</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-clock"></i></span>
          <select name="preferred_time" class="form-select">
            <option value="morning" {% if profile.preferred_time == 'morning' %}selected{% endif %}>Morning</option>
            <option value="afternoon" {% if profile.preferred_time == 'afternoon' %}selected{% endif %}>Afternoon</option>
            <option value="evening" {% if profile.preferred_time == 'evening' %}selected{% endif %}>Evening</option>
          </select>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="mb-3">
        <label class="form-label fw-semibold">Trash types</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-trash"></i></span>
          <input type="text" name="trash_types" class="form-control" value="{{ profile.trash_types }}" placeholder="household,recyclable" />
        </div>
      </div>
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label fw-semibold">Special instructions</label>
    <div class="input-group">
      <span class="input-group-text"><i class="bi bi-chat-text"></i></span>
      <textarea name="special_instructions" class="form-control" rows="2">{{ profile.special_instructions }}</textarea>
    </div>
  </div>

  <hr />
  <h5 class="text-primary"><i class="bi bi-geo-alt me-2"></i>Pickup Location</h5>
  
  <div class="mb-3">
    <label class="form-label fw-semibold">Address</label>
    <div class="input-group">
      <span class="input-group-text"><i class="bi bi-house"></i></span>
      <input type="text" id="address_text" name="address_text" class="form-control" value="{{ profile.address_text }}" />
    </div>
  </div>
  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label fw-semibold">Region</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-pin-map"></i></span>
        <input type="text" id="region" name="region" class="form-control" value="{{ profile.region }}" />
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label fw-semibold">Landmark</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-signpost"></i></span>
        <input type="text" id="landmark" name="landmark" class="form-control" value="{{ profile.landmark }}" />
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label fw-semibold">Latitude</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-geo"></i></span>
        <input type="text" id="latitude" name="latitude" class="form-control" value="{{ profile.latitude }}" readonly />
      </div>
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label fw-semibold">Longitude</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-geo"></i></span>
        <input type="text" id="longitude" name="longitude" class="form-control" value="{{ profile.longitude }}" readonly />
      </div>
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label fw-semibold">Select location on map</label>
    <div id="map" style="height: 350px; width: 100%; border:2px solid var(--primary-blue); border-radius: 0.5rem;"></div>
    <div class="form-text mt-2">
      <i class="bi bi-info-circle me-1"></i>Map data by OpenStreetMap; reverse geocoding via Nominatim.
    </div>
  </div>

  <!-- Leaflet CSS & JS (unchanged) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Leaflet init script – completely preserved -->
  <script>
    let map, marker;
    function setLatLng(lat, lng) {
      document.getElementById('latitude').value = Number(lat).toFixed(6);
      document.getElementById('longitude').value = Number(lng).toFixed(6);
    }
    function initMap() {
      const lat = parseFloat(document.getElementById('latitude').value) || 6.5244;
      const lng = parseFloat(document.getElementById('longitude').value) || 3.3792;
      map = L.map('map').setView([lat, lng], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      marker = L.marker([lat, lng], { draggable: true }).addTo(map);
      marker.on('dragend', function(e) {
        const pos = e.target.getLatLng();
        setLatLng(pos.lat, pos.lng);
        autofillAddress(pos.lat, pos.lng);
      });
      map.on('click', function(e) {
        marker.setLatLng(e.latlng);
        setLatLng(e.latlng.lat, e.latlng.lng);
        autofillAddress(e.latlng.lat, e.latlng.lng);
      });
    }
    function autofillAddress(lat, lng) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
      fetch(url, { headers: { 'Accept': 'application/json' } })
        .then(resp => resp.json())
        .then(data => {
          if (!data || !data.address) return;
          if (data.display_name) {
            document.getElementById('address_text').value = data.display_name;
          }
          const addr = data.address;
          const region = addr.state || addr.region || addr.county || '';
          const landmark = addr.suburb || addr.neighbourhood || addr.city_district || addr.city || addr.town || addr.village || '';
          document.getElementById('region').value = region;
          document.getElementById('landmark').value = landmark;
        })
        .catch(() => {});
    }
    window.onload = initMap;
  </script>

  <button class="btn btn-primary btn-lg px-5 mt-3" type="submit">
    <i class="bi bi-save me-2"></i>Save profile
  </button>
</form>

<!-- Validation script – untouched, only borderColor logic -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('profileEditForm');
  form.addEventListener('submit', function(e) {
    let firstInvalid = null;
    let valid = true;
    const required = ['address_text', 'region', 'latitude', 'longitude'];
    form.querySelectorAll('.form-control').forEach(el => {
      el.style.borderColor = '';
    });
    for (let name of required) {
      let el = form.querySelector(`[name="${name}"]`);
      if (!el) continue;
      let value = el.value.trim();
      if (!value) {
        valid = false;
        el.style.borderColor = 'red';
        if (!firstInvalid) firstInvalid = el;
      }
    }
    if (!valid) {
      e.preventDefault();
      if (firstInvalid) {
        firstInvalid.scrollIntoView({behavior: 'smooth', block: 'center'});
        firstInvalid.focus();
        alert('Please fill in all required address/location fields.');
      }
    }
  });
});
</script>
{% endblock %}