{% extends 'base.html' %}
{% block content %}
<h2>Edit Profile</h2>
<form method="post" action="" id="profileEditForm">
  {% csrf_token %}
  <div class="mb-3">
    <label class="form-label">Phone</label>
    <input type="text" name="phone" class="form-control" value="{{ profile.phone }}" />
  </div>
  <div class="mb-3">
    <label class="form-label">Backup contact</label>
    <input type="text" name="backup_contact" class="form-control" value="{{ profile.backup_contact }}" />
  </div>
  <div class="mb-3">
    <label class="form-label">Notification method</label>
    <select name="notification_method" class="form-select">
      <option value="sms" {% if profile.notification_method == 'sms' %}selected{% endif %}>SMS</option>
      <option value="email" {% if profile.notification_method == 'email' %}selected{% endif %}>Email</option>
      <option value="inapp" {% if profile.notification_method == 'inapp' %}selected{% endif %}>In-app</option>
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Preferred days</label>
    <input type="text" name="preferred_days" class="form-control" value="{{ profile.preferred_days }}" placeholder="Mon,Tue,Fri" />
  </div>
  <div class="mb-3">
    <label class="form-label">Preferred time</label>
    <select name="preferred_time" class="form-select">
      <option value="morning" {% if profile.preferred_time == 'morning' %}selected{% endif %}>Morning</option>
      <option value="afternoon" {% if profile.preferred_time == 'afternoon' %}selected{% endif %}>Afternoon</option>
      <option value="evening" {% if profile.preferred_time == 'evening' %}selected{% endif %}>Evening</option>
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Trash types</label>
    <input type="text" name="trash_types" class="form-control" value="{{ profile.trash_types }}" placeholder="household,recyclable" />
  </div>
  <div class="mb-3">
    <label class="form-label">Special instructions</label>
    <textarea name="special_instructions" class="form-control" rows="2">{{ profile.special_instructions }}</textarea>
  </div>
  <hr />
  <h5>Pickup Location</h5>
  <div class="mb-3">
    <label class="form-label">Address</label>
    <input type="text" id="address_text" name="address_text" class="form-control" value="{{ profile.address_text }}" />
  </div>
  <div class="mb-3">
    <label class="form-label">Region</label>
    <input type="text" id="region" name="region" class="form-control" value="{{ profile.region }}" />
  </div>
  <div class="mb-3">
    <label class="form-label">Landmark</label>
    <input type="text" id="landmark" name="landmark" class="form-control" value="{{ profile.landmark }}" />
  </div>
  <div class="mb-3">
    <label class="form-label">Latitude</label>
    <input type="text" id="latitude" name="latitude" class="form-control" value="{{ profile.latitude }}" readonly />
  </div>
  <div class="mb-3">
    <label class="form-label">Longitude</label>
    <input type="text" id="longitude" name="longitude" class="form-control" value="{{ profile.longitude }}" readonly />
  </div>
  <div class="mb-3">
    <label class="form-label">Select location on map</label>
    <div id="map" style="height: 350px; width: 100%; border:1px solid #ccc;"></div>
    <div class="form-text">
      Map data by OpenStreetMap; reverse geocoding via Nominatim.
    </div>
  </div>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    let map, marker;
    function setLatLng(lat, lng) {
      document.getElementById('latitude').value = Number(lat).toFixed(6);
      document.getElementById('longitude').value = Number(lng).toFixed(6);
    }
    function initMap() {
      const lat = parseFloat(document.getElementById('latitude').value) || 6.5244;
      const lng = parseFloat(document.getElementById('longitude').value) || 3.3792;
      map = L.map('map').setView([lat, lng], 14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      marker = L.marker([lat, lng], { draggable: true }).addTo(map);
      marker.on('dragend', function(e) {
        const pos = e.target.getLatLng();
        setLatLng(pos.lat, pos.lng);
        autofillAddress(pos.lat, pos.lng);
      });
      map.on('click', function(e) {
        marker.setLatLng(e.latlng);
        setLatLng(e.latlng.lat, e.latlng.lng);
        autofillAddress(e.latlng.lat, e.latlng.lng);
      });
    }
    function autofillAddress(lat, lng) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
      fetch(url, {
        headers: { 'Accept': 'application/json' }
      })
        .then(resp => resp.json())
        .then(data => {
          if (!data || !data.address) return;
          if (data.display_name) {
            document.getElementById('address_text').value = data.display_name;
          }
          const addr = data.address;
          const region = addr.state || addr.region || addr.county || '';
          const landmark = addr.suburb || addr.neighbourhood || addr.city_district || addr.city || addr.town || addr.village || '';
          document.getElementById('region').value = region;
          document.getElementById('landmark').value = landmark;
        })
        .catch(() => {
          // Ignore reverse geocode failures; user can fill manually.
        });
    }
    window.onload = initMap;
  </script>
  <button class="btn btn-primary" type="submit">Save profile</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('profileEditForm');
  form.addEventListener('submit', function(e) {
    let firstInvalid = null;
    let valid = true;
    // List of required address/location fields
    const required = [
      'address_text', 'region', 'latitude', 'longitude'
    ];
    // Remove previous highlights
    form.querySelectorAll('.form-control').forEach(el => {
      el.style.borderColor = '';
    });
    // Validate required fields
    for (let name of required) {
      let el = form.querySelector(`[name="${name}"]`);
      if (!el) continue;
      let value = el.value.trim();
      if (!value) {
        valid = false;
        el.style.borderColor = 'red';
        if (!firstInvalid) firstInvalid = el;
      }
    }
    if (!valid) {
      e.preventDefault();
      if (firstInvalid) {
        firstInvalid.scrollIntoView({behavior: 'smooth', block: 'center'});
        firstInvalid.focus();
        alert('Please fill in all required address/location fields.');
      }
    }
  });
});
</script>
{% endblock %}
