{% extends 'base.html' %}

{% block content %}
<div class="container mt-4 notifications-page">
  <h2 class="mb-4"><i class="bi bi-bell-fill text-primary me-2"></i>Notifications</h2>
  {% if notifications %}
    <div class="row g-3">
      {% for n in notifications %}
        <div class="col-12">
          <div class="card notification-card {% if n.read %}notification-read{% else %}notification-unread{% endif %}">
            <div class="card-body d-flex justify-content-between align-items-start">
              <div class="d-flex">
                <div class="notification-icon">
                  {% if n.level == 'success' %}
                    <i class="bi bi-check-circle-fill"></i>
                  {% elif n.level == 'warning' %}
                    <i class="bi bi-exclamation-triangle-fill"></i>
                  {% elif n.level == 'error' %}
                    <i class="bi bi-x-circle-fill"></i>
                  {% else %}
                    <i class="bi bi-info-circle-fill"></i>
                  {% endif %}
                </div>
                <div>
                  <div class="fw-bold">{{ n.level|capfirst }}</div>
                  <div>{{ n.message }}</div>
                  {% if n.link %}
                    <small><a href="{{ n.link }}" class="text-primary text-decoration-none">View <i class="bi bi-arrow-right-short"></i></a></small>
                  {% endif %}
                </div>
              </div>
              <div class="text-end">
                <div class="text-muted small">{{ n.created_at|date:"M j, Y H:i" }}</div>
                {% if n.recipient %}
                  <button class="btn btn-sm btn-outline-primary toggle-read-btn mt-2" data-id="{{ n.id }}">
                    <i class="bi {% if n.read %}bi-bookmark-check{% else %}bi-bookmark{% endif %} me-1"></i>
                    {% if n.read %}Mark unread{% else %}Mark read{% endif %}
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info d-flex align-items-center">
      <i class="bi bi-info-circle-fill me-2 fs-4"></i>
      No notifications at this time.
    </div>
  {% endif %}
</div>

{% block extra_scripts %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('click', function(e){
  if(!e.target.matches('.toggle-read-btn') && !e.target.closest('.toggle-read-btn')) return;
  const btn = e.target.closest('.toggle-read-btn');
  const id = btn.dataset.id;
  fetch(`/notifications/toggle/${id}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Accept': 'application/json'
    },
    credentials: 'same-origin'
  }).then(r => r.json()).then(data => {
    if(!data.ok){
      alert(data.error || 'Failed to update notification');
      return;
    }
    // update button text and icon
    btn.innerHTML = data.read 
      ? '<i class="bi bi-bookmark me-1"></i>Mark unread' 
      : '<i class="bi bi-bookmark-check me-1"></i>Mark read';
    const card = btn.closest('.notification-card');
    if(data.read) {
      card.classList.add('notification-read');
      card.classList.remove('notification-unread');
    } else {
      card.classList.remove('notification-read');
      card.classList.add('notification-unread');
    }
  }).catch(()=> alert('Network error'));
});
</script>
{% endblock %}
{% endblock %}
