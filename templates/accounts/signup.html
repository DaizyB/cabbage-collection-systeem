{% extends 'base.html' %}
{% block content %}
<h2>Signup</h2>
{% if form.non_field_errors %}
  <div class="alert alert-danger">
    <ul class="mb-0">
      {% for e in form.non_field_errors %}
        <li>{{ e }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<form method="post" action="" id="signup-form" novalidate>
  {% csrf_token %}

  {% for field in form.visible_fields %}
    <div class="mb-3">
      <label for="id_{{ field.name }}" class="form-label">{{ field.label }}{% if field.field.required %} *{% endif %}</label>
      {% if field.name == 'password1' or field.name == 'password2' %}
        <div class="input-group">
          {{ field }}
          <button type="button" class="btn btn-outline-secondary btn-sm toggle-pw" data-target="id_{{ field.name }}" aria-label="Toggle password visibility">Show</button>
        </div>
      {% else %}
        {{ field }}
      {% endif %}
      {% if field.help_text and field.name != 'password1' %}
        <div class="form-text">{{ field.help_text }}</div>
      {% endif %}
      {% if field.errors %}
        <div class="invalid-feedback d-block">
          {% for err in field.errors %}
            {% if field.name == 'password1' %}
              {% if 'too similar' in err or 'contain at least' in err or 'commonly used' in err or 'entirely numeric' in err %}
                {# skip default password validator messages #}
              {% else %}
                {{ err }}{% if not forloop.last %}<br>{% endif %}
              {% endif %}
            {% else %}
              {{ err }}{% if not forloop.last %}<br>{% endif %}
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>
  {% endfor %}

  <div class="mb-3">
    <label class="form-label">Password requirements</label>
    <ul id="pw-rules" class="list-unstyled mb-2">
      <li data-rule="length" class="text-muted">• At least 8 characters</li>
      <li data-rule="uppercase" class="text-muted">• At least one uppercase letter</li>
      <li data-rule="lowercase" class="text-muted">• At least one lowercase letter</li>
      <li data-rule="digit" class="text-muted">• At least one number</li>
      <li data-rule="special" class="text-muted">• At least one special character (e.g. @!#)</li>
      <li data-rule="match" class="text-muted">• Passwords match</li>
    </ul>
  </div>

  <button class="btn btn-primary" type="submit" id="signup-submit">Sign up</button>
</form>

<script>
;(function(){
  const pw1 = document.querySelector('input[name="password1"]');
  const pw2 = document.querySelector('input[name="password2"]');
  const rules = document.getElementById('pw-rules');
  const submit = document.getElementById('signup-submit');
  if (!pw1 || !pw2 || !rules) return;

  const ruleItems = Array.from(rules.querySelectorAll('li'));

  function checkRules(){
    const v1 = pw1.value || '';
    const v2 = pw2.value || '';
    const checks = {
      length: v1.length >= 8,
      uppercase: /[A-Z]/.test(v1),
      lowercase: /[a-z]/.test(v1),
      digit: /\d/.test(v1),
      special: /[^A-Za-z0-9]/.test(v1),
      match: v1 !== '' && v1 === v2
    };
    ruleItems.forEach(li => {
      const key = li.getAttribute('data-rule');
      if (checks[key]) {
        li.classList.remove('text-muted');
        li.classList.add('text-success');
      } else {
        li.classList.remove('text-success');
        li.classList.add('text-muted');
      }
    });
    // enable submit only if all rules pass
    const allOk = Object.values(checks).every(Boolean);
    submit.disabled = !allOk;
  }

  pw1.addEventListener('input', checkRules);
  pw2.addEventListener('input', checkRules);
  // run once on load
  checkRules();

  // Toggle show/hide for password fields
  const toggles = Array.from(document.querySelectorAll('.toggle-pw'));
  toggles.forEach(btn => {
    const targetId = btn.getAttribute('data-target');
    const input = document.getElementById(targetId);
    if (!input) return;
    btn.addEventListener('click', function(){
      if (input.type === 'password'){
        input.type = 'text';
        btn.textContent = 'Hide';
      } else {
        input.type = 'password';
        btn.textContent = 'Show';
      }
    });
  });

  // HTML5 client-side feedback: toggle invalid class when server responded with errors
  const form = document.getElementById('signup-form');
  form.addEventListener('submit', function(e){
    // allow submission; server will perform final validation
    // but keep submit disabled if client-side checks fail
    if (submit.disabled){
      e.preventDefault();
      pw1.focus();
    }
  });
})();
</script>
<p class="mt-3">Already have an account? <a href="/accounts/login/">Log in</a></p>
{% endblock %}
